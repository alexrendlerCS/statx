<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Generate NFL player projections based on defense.">
    <title>Player Projections</title>
    <link href="./style.css" rel="stylesheet">
    <style>
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #2a3f54;
        color: #ffffff;
        font-weight: bold;
      }
      tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      tr:hover {
        background-color: #f1f1f1;
      }
      .loading {
        text-align: center;
        color: #666;
        margin-top: 20px;
      }
      .error {
        text-align: center;
        color: red;
        margin-top: 20px;
      }
      /* Styles for suggestions dropdown */
      .suggestions {
        position: absolute;
        border: 1px solid #ddd;
        max-height: 150px;
        overflow-y: auto;
        background-color: white;
        width: 100%;
        z-index: 1000;
      }
      .suggestion-item {
        padding: 8px;
        cursor: pointer;
      }
      .suggestion-item:hover {
        background-color: #f1f1f1;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo">
        <h1>Stats X</h1>
      </div>
      <nav>
        <a href="index.html">Home</a>
        <a href="defense.html">Defense v.s. Position</a>
        <a href="playerStats.html">Player Stats</a>
        <a href="playerProjections.html">Player Projections</a>
      </nav>
    </header>

    <div class="right_col" role="main" style="margin-bottom: 500px">
      <div class="container">
        <h1>NFL Player Projections</h1>
        <form id="projectionForm">
          <label for="playerName">Enter NFL Player Name (e.g., Saquon Barkley):</label>
          <div style="position: relative;">
            <input type="text" id="playerName" name="playerName" required autocomplete="off">
            <div id="suggestions" class="suggestions"></div>
          </div>

          <label for="defenseTeam">Select Opponent Defense:</label>
          <select id="defenseTeam" name="defenseTeam" required>
            <option value="">-- Select Defense --</option>
            <option value="SF">49ers</option>
            <option value="CHI">Bears</option>
            <option value="CIN">Bengals</option>
            <option value="BUF">Bills</option>
            <option value="DEN">Broncos</option>
            <option value="CLE">Browns</option>
            <option value="TB">Buccaneers</option>
            <option value="ARI">Cardinals</option>
            <option value="LAC">Chargers</option>
            <option value="KC">Chiefs</option>
            <option value="IND">Colts</option>
            <option value="WAS">Commanders</option>
            <option value="DAL">Cowboys</option>
            <option value="MIA">Dolphins</option>
            <option value="PHI">Eagles</option>
            <option value="ATL">Falcons</option>
            <option value="NYG">Giants</option>
            <option value="JAC">Jaguars</option>
            <option value="NYJ">Jets</option>
            <option value="DET">Lions</option>
            <option value="GB">Packers</option>
            <option value="CAR">Panthers</option>
            <option value="NE">Patriots</option>
            <option value="LV">Raiders</option>
            <option value="LAR">Rams</option>
            <option value="BAL">Ravens</option>
            <option value="NO">Saints</option>
            <option value="SEA">Seahawks</option>
            <option value="PIT">Steelers</option>
            <option value="HOU">Texans</option>
            <option value="TEN">Titans</option>
            <option value="MIN">Vikings</option>
          </select>
          <button type="submit">Generate Projection</button>
        </form>

        <div id="statsContainer">
          <!-- The projection data will be displayed here -->
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; 2024 Stats X. All rights reserved.</p>
    </footer>

    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

      // Supabase credentials
      const supabaseUrl = 'https://xrstrludepuahpovxpzb.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhyc3RybHVkZXB1YWhwb3Z4cHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE1NjA5OTcsImV4cCI6MjA0NzEzNjk5N30.zi3dWGxLif4__7tSOn2-r2nS1wZI_SLBUpHGMpKMznI'; // Replace with your actual key
      const supabase = createClient(supabaseUrl, supabaseKey);

      const playerNameInput = document.getElementById("playerName");
      const defenseTeamSelect = document.getElementById("defenseTeam");
      const suggestionsBox = document.getElementById("suggestions");
      const form = document.getElementById("projectionForm");
      const statsContainer = document.getElementById("statsContainer");

      const normalizeString = (str) => str.toLowerCase().replace(/[-.`]/g, "").trim();

      // Event listener for player name input (suggestions)
      playerNameInput.addEventListener("input", async () => {
          const query = normalizeString(playerNameInput.value)
              .replace(/[-`'.]/g, ""); // Normalize user input by removing -, ', `, and .

          suggestionsBox.innerHTML = ""; // Clear previous suggestions

          if (query) {
              try {
                  // Fetch player names from Supabase
                  const { data: players, error } = await supabase
                      .from('player_list') // Replace with your actual table name
                      .select('player_name');

                  if (error) {
                      console.error('Error fetching player names:', error.message);
                      return;
                  }

                  if (!players || players.length === 0) {
                      console.log('No matching players found.');
                      return;
                  }

                  // Normalize and filter suggestions
                  const matchingPlayers = players.filter(player =>
                      normalizeString(player.player_name).replace(/[-`'.]/g, "").includes(query)
                  );

                  matchingPlayers.forEach(player => {
                      const suggestionItem = document.createElement("div");
                      suggestionItem.className = "suggestion-item";
                      suggestionItem.textContent = player.player_name;
                      suggestionItem.addEventListener("click", () => {
                          playerNameInput.value = player.player_name; // Use the exact database name
                          suggestionsBox.innerHTML = ""; // Clear suggestions
                      });
                      suggestionsBox.appendChild(suggestionItem);
                  });
              } catch (err) {
                  console.error('Unexpected error fetching suggestions:', err.message);
              }
          }
      });
  
      // Hide suggestions when clicking outside
      document.addEventListener("click", (event) => {
          if (!suggestionsBox.contains(event.target) && event.target !== playerNameInput) {
              suggestionsBox.innerHTML = "";
          }
      });
      // Form submission to generate projections
      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const playerName = playerNameInput.value.replace(/`/g, "'").trim();
        const defenseTeam = defenseTeamSelect.value;

        if (!playerName || !defenseTeam) {
          statsContainer.innerHTML = '<p class="error">Please select a player and a defense.</p>';
          return;
        }

        statsContainer.innerHTML = '<p class="loading">Generating projections...</p>';

        try {
          // Fetch player data
          const { data: playerData, error: playerError } = await supabase
            .from("player_averages")
            .select("*")
            .eq("player_name", playerName)
            .single();

          if (playerError || !playerData) {
            throw new Error(`Player data not found for "${playerName}".`);
          }

          // Fetch specific defense averages
          const defenseTable = playerData.position_id === "QB" ? "defense_averages_qb" : "defense_averages";
          const query = supabase.from(defenseTable).select("*").eq("team_id", defenseTeam);

          if (playerData.position_id !== "QB") {
            query.eq("position_id", playerData.position_id); // Add position_id filter for non-QBs
          }

          const { data: defenseStats, error: defenseError } = await query;


          if (defenseError || !defenseStats || defenseStats.length === 0) {
            throw new Error(`No defensive stats found for team: ${defenseTeam} and position: ${playerData.position_id}.`);
          }

          const specificDefense = defenseStats[0];

          // Fetch league-wide defense averages
          const allDefenseTable = playerData.position_id === "QB" ? "all_defense_averages_qb" : "all_defense_averages";
          let query1 = supabase.from(allDefenseTable).select("*");

          if (playerData.position_id !== "QB") {
            query1 = query1.eq("position_id", playerData.position_id); // Add position_id filter for non-QBs
          }

          const { data: leagueDefense, error: leagueError } = await query1.single();

          if (leagueError || !leagueDefense) {
            throw new Error(`No league-wide defense stats found for position: ${playerData.position_id}.`);
          }


          const projection = {};
          for (const key in playerData) {
            if (key.startsWith("avg_")) {
              const statKey = key.replace("avg_", ""); // Remove "avg_" prefix for readability
              const specificStat = specificDefense[`avg_${statKey}`]; // Add "avg_" back for defense stats
              const leagueStat = leagueDefense[`avg_${statKey}`]; // Add "avg_" back for league-wide stats

              if (specificStat !== undefined && leagueStat !== undefined) {
                // Calculate projection based on player average and defense stats
                projection[statKey] = (
                  playerData[key] * (specificStat / leagueStat)
                ).toFixed(2);
              } else {
                // Log missing data and fallback to player average
                console.warn(`Missing data for avg_${statKey}. Defaulting to player average.`);
                projection[statKey] = playerData[key].toFixed(2);
              }
            }
          }

          // Filter projections based on player position
          const positionStats = {
            QB: ["passing_attempts", "completions", "passing_yards", "passing_tds", "interceptions", "rushing_attempts", "rushing_yards", "rushing_tds"],
            WR: ["receptions", "receiving_yards", "receiving_tds"],
            RB: ["rushing_attempts", "rushing_yards", "rushing_tds", "receptions", "receiving_yards", "receiving_tds"],
          };

          const allowedStats = positionStats[playerData.position_id] || [];
          const filteredProjection = Object.fromEntries(
            Object.entries(projection).filter(([key]) => allowedStats.includes(key))
          );

          // Display projections in a table
          let tableHtml = '<table><thead><tr><th>Stat</th><th>Projection</th></tr></thead><tbody>';
          for (const [stat, value] of Object.entries(filteredProjection)) {
            tableHtml += `<tr><td>${stat}</td><td>${value}</td></tr>`;
          }
          tableHtml += "</tbody></table>";

          statsContainer.innerHTML = tableHtml;
        } catch (error) {
          statsContainer.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        }
      });
    </script>
  </body>
</html>