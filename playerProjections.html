<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Generate NFL player projections based on defense.">
    <title>Player Projections</title>
    <link href="./style.css" rel="stylesheet">
    <style>
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #2a3f54;
        color: #ffffff;
        font-weight: bold;
      }
      tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      tr:hover {
        background-color: #f1f1f1;
      }
      .loading {
        text-align: center;
        color: #666;
        margin-top: 20px;
      }
      .error {
        text-align: center;
        color: red;
        margin-top: 20px;
      }
      /* Styles for suggestions dropdown */
      .suggestions {
        position: absolute;
        border: 1px solid #ddd;
        max-height: 150px;
        overflow-y: auto;
        background-color: white;
        width: 100%;
        z-index: 1000;
      }
      .suggestion-item {
        padding: 8px;
        cursor: pointer;
      }
      .suggestion-item:hover {
        background-color: #f1f1f1;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo">
        <h1>Stats X</h1>
      </div>
      <nav>
        <a href="index.html">Home</a>
        <a href="defenseStats.html">Defense v.s. Position</a>
        <a href="playerStats.html">Player Stats</a>
      </nav>
    </header>

    <div class="right_col" role="main" style="margin-bottom: 500px">
      <div class="container">
        <h1>NFL Player Projections</h1>
        <form id="projectionForm">
          <label for="playerName">Enter NFL Player Name (e.g., Saquon Barkley):</label>
          <div style="position: relative;">
            <input type="text" id="playerName" name="playerName" required autocomplete="off">
            <div id="suggestions" class="suggestions"></div>
          </div>

          <label for="defenseTeam">Select Opponent Defense:</label>
          <select id="defenseTeam" name="defenseTeam" required>
            <option value="">-- Select Defense --</option>
            <option value="SF">49ers</option>
            <option value="CHI">Bears</option>
            <option value="CIN">Bengals</option>
            <option value="BUF">Bills</option>
            <!-- Add all teams -->
          </select>
          <button type="submit">Generate Projection</button>
        </form>

        <div id="statsContainer">
          <!-- The projection data will be displayed here -->
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; 2024 Stats X. All rights reserved.</p>
    </footer>

    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

      // Supabase credentials
      const supabaseUrl = 'https://xrstrludepuahpovxpzb.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhyc3RybHVkZXB1YWhwb3Z4cHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE1NjA5OTcsImV4cCI6MjA0NzEzNjk5N30.zi3dWGxLif4__7tSOn2-r2nS1wZI_SLBUpHGMpKMznI'; // Replace with your actual key
      const supabase = createClient(supabaseUrl, supabaseKey);

      const playerNameInput = document.getElementById("playerName");
      const defenseTeamSelect = document.getElementById("defenseTeam");
      const suggestionsBox = document.getElementById("suggestions");
      const form = document.getElementById("projectionForm");
      const statsContainer = document.getElementById("statsContainer");

      // Fetch player suggestions
      playerNameInput.addEventListener("input", async () => {
        const query = playerNameInput.value.trim().toLowerCase();
        suggestionsBox.innerHTML = "";

        if (!query) return;

        const { data: players, error } = await supabase
          .from("player_list") // Replace with your player list table name
          .select("player_name");

        if (error) {
          console.error("Error fetching player names:", error.message);
          return;
        }

        players
          .filter(player => player.player_name.toLowerCase().includes(query))
          .forEach(player => {
            const suggestionItem = document.createElement("div");
            suggestionItem.className = "suggestion-item";
            suggestionItem.textContent = player.player_name;
            suggestionItem.addEventListener("click", () => {
              playerNameInput.value = player.player_name;
              suggestionsBox.innerHTML = "";
            });
            suggestionsBox.appendChild(suggestionItem);
          });
      });

        // Form submission to generate projections
        form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const playerName = playerNameInput.value.trim();
        const defenseTeam = defenseTeamSelect.value;

        if (!playerName || !defenseTeam) {
            statsContainer.innerHTML = '<p class="error">Please select a player and a defense.</p>';
            return;
        }

        statsContainer.innerHTML = '<p class="loading">Generating projections...</p>';

        try {
            // Fetch player data
            const { data: playerData, error: playerError } = await supabase
            .from("player_averages") // Replace with your player averages table
            .select("*")
            .eq("player_name", playerName)
            .single();

            if (playerError || !playerData) {
            throw new Error(`Player data not found for "${playerName}".`);
            }

            // Fetch defensive stats
            const { data: defenseData, error: defenseError } = await supabase
            .from("general_defensive_stats") // Adjust table name as necessary
            .select("*")
            .eq("team_id", defenseTeam)
            .eq("position_id", playerData.position_id);

            if (defenseError || !defenseData || defenseData.length === 0) {
            throw new Error(
                `No defensive data found for team: ${defenseTeam} and position: ${playerData.position_id}`
            );
            }

            // Aggregate defensive stats
            const aggregatedDefense = defenseData.reduce(
            (acc, row) => {
                for (const key in row) {
                if (typeof row[key] === "number") {
                    acc[key] = (acc[key] || 0) + row[key];
                }
                }
                return acc;
            },
            {}
            );

            // Calculate averages
            for (const key in aggregatedDefense) {
            aggregatedDefense[key] /= defenseData.length;
            }

            console.log("Player Data:", playerData);
            console.log("Aggregated Defense Data:", aggregatedDefense);

            const leagueAverages = {
                receptions: 8,
                receiving_yards: 28.5,
                receiving_tds: 1
            };

            const projection = {};
            for (const key in playerData) {
                if (key.startsWith("avg_")) {
                    const statKey = key.replace("avg_", "");
                    const defenseStat = aggregatedDefense[statKey];

                    if (defenseStat !== undefined && defenseStat !== null) {
                    const leagueAverage = leagueAverages[statKey] || 1; // Use league average or 1
                    projection[statKey] = (
                        playerData[key] * (defenseStat / leagueAverage)
                    ).toFixed(2);
                    } else {
                    console.warn(`Missing defensive stat for ${statKey}. Defaulting to player average.`);
                    projection[statKey] = playerData[key] ? playerData[key].toFixed(2) : "0.00";
                    }
                }
            }
            console.log("Projection:", projection);

            // Filter projections by position
            const position = playerData.position_id; // Player position, e.g., "WR", "QB"

            const relevantStats = {
            QB: ["passing_attempts", "completions", "passing_yards", "passing_tds", "interceptions"],
            WR: ["receptions", "receiving_yards", "receiving_tds"],
            RB: ["rushing_attempts", "rushing_yards", "rushing_tds"],
            };

            const allowedStats = relevantStats[position] || [];

            // Filter and calculate only for relevant stats
            const filteredProjection = {};
            for (const stat of allowedStats) {
            if (projection[stat]) {
                filteredProjection[stat] = projection[stat];
            }
            }

            // Display projections in a table
            let tableHtml = '<table><thead><tr><th>Stat</th><th>Projection</th></tr></thead><tbody>';
            for (const [stat, value] of Object.entries(filteredProjection)) {
            tableHtml += `<tr><td>${stat}</td><td>${value}</td></tr>`;
            }
            tableHtml += "</tbody></table>";

            statsContainer.innerHTML = tableHtml;
        } catch (error) {
            statsContainer.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        }
        });
    </script>
  </body>
</html>